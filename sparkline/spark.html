<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
   <style>
      .canvas { z-order: 1; opacity: 0.8; }
      .data-overlay { position: relative; width:0; height: 0;}
      .data-overlay-inner { position: absolute; left: 10px; z-order: -1;}
      table,th,td { border: none;}
      table {font-size:200%;}
      .hidden { display: none; }
      .tools { font-size:200%; position: fixed; top: 0px; right: 0px; }
      a.selected { background-color: lightgray;}
      a { text-decoration: none; }
    </style>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jquery.sparkline.js"></script>
    <script type="text/javascript" src="jquery.appear.js"></script>
    <script type="text/javascript" src="reconnecting-websocket.js"></script>
    <script type="text/javascript">
    var stored_data = {};
    function changeloc(oldloc,newloc){
       if(newloc!=="")
       { $(".tools").removeClass("hidden") }
       else
       { $(".tools").addClass("hidden") }
       if(newloc==="")
       {
         $(".hidden").removeClass("hidden")
         $(".filter-"+oldloc+" td a[href=#filter-"+oldloc+"]").removeClass("selected")
       } else {
         $("tr").addClass("hidden")
         $(".filter-"+newloc).removeClass("hidden");
         $(".filter-"+newloc+" td a[href=#filter-"+newloc+"]").addClass("selected")
         $(".filter-"+oldloc+" td a[href=#filter-"+oldloc+"]").removeClass("selected")
       }
    }
    function hash(url){
      return (((new URL(url)).hash)+"").replace("#","")
    }
    function types(url){
      return hash(url).split(" ").reduce(
        function(o,n){
          key = n.split("-")[0]
          if (o[key] === undefined)
             { o[key]=[]; }
          o[key].push(n.replace(/^\w+-/,""));
          return o;
        }, new Object()
      );
    }
    $(function() {
       if (document.location.protocol === 'https:') {
         var host = 'wss://'+document.location.host+'/ws.json'
       } else
       {
         var host = 'ws://'+document.location.host+'/ws.json'
       }
       console.log("Sparkline attempting to connect to",host)
       var ws = new ReconnectingWebSocket(host);
       window.onhashchange = function(evt){
         console.log(types(evt.newURL));
         var newloc = hash(evt.newURL).replace("filter-","")
         var oldloc = hash(evt.oldURL).replace("filter-","")
         changeloc(oldloc,newloc)
       }
       ws.onmessage = function(evt) {
         data = JSON.parse(evt.data);
         if(document.getElementById("set").childNodes.length>0)
         { $('#waiting').remove() }
         $.extend(data["Dists"],data["Counters"])
         $.each(data["Dists"],function(k,v){
             if(!stored_data.hasOwnProperty(k))
             {
               stored_data[k]=[];
             }
             if((typeof v)==="number"){
               stored_data[k].push(v)
             } else {
               stored_data[k].push(v.Sum_x/v.N)
             }
             if(stored_data[k].length > 60)
             { stored_data[k].shift();}
             var name = k.replace(/\./g, "_");
             if(document.getElementById("spark-"+name) && stored_data[k].length > 1){
                $('#spark-'+name).sparkline(stored_data[k], {type: 'line'})
                $('#data-overlay-'+name).text(stored_data[k].slice(-1)[0].toFixed(3))
             }else{
                var click_filters = k.split(/\./)
                var classes = click_filters.map(function(f){return "filter-"+f;}).join(" ")
                if ( document.location.hash.match(/^filter-/) &&
                     classes.indexOf(document.location.hash)==-1 )
                { classes.push("hidden") }
                var parts = click_filters.map(function(f){
                  if(("#filter-"+f)===document.location.hash){
                    return "<a class='selected' href='#filter-"+f+"'>"+f+"</a>"
                  } else {
                    return "<a href='#filter-"+f+"'>"+f+"</a>"
                  }
                }).join(".")
                $('#set').append($("<tr class='"+classes+"'><td>"+parts+"</td><td><span class='data-overlay'><span class='data-overlay-inner' id='data-overlay-"+name+"'>"+stored_data[k].slice(-1)[0].toFixed(3)+"</span></span><a href='#graph-"+k+"'><span class='canvas' id='spark-"+name+"'></span></a></td></tr>"));
             }});
         };
    });
    </script>
</head>
<body>
  <h4 id="waiting">Waiting for data</h4>
  <span class="tools"><a id="collapse">C</a></span><a href="#">&#9003;</a></span>
  <table>
    <tbody id="set">
    </tbody>
  </table>
</body>
</html>
