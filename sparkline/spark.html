<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
   <style>
      .canvas { z-order: 1; opacity: 0.8; }
      .data-overlay { position: relative; width:0; height: 0;}
      .data-overlay-inner { position: absolute; left: 10px; z-order: -1;}
      table,th,td { border: none;}
      table {font-size:200%;}
      .hidden { display: none; }
      .tools { font-size:200%; position: fixed; top: 0px; right: 0px; }
      .rm-filter {font-size:25%; position:relative; top: -2em;}
      a.selected { background-color: lightgray;}
      a { text-decoration: none; cursor:pointer; color: darkblue;}
    </style>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jquery.sparkline.js"></script>
    <script type="text/javascript" src="jquery.appear.js"></script>
    <script type="text/javascript" src="reconnecting-websocket.js"></script>
    <script type="text/javascript">
    var stored_data = {};
    function changeloc(oldloc,newloc){
       oldfilterset = types(oldloc).filter || [];
       newfilterset = types(newloc).filter || [];
       console.log("moving from",oldfilterset,"to",newfilterset)
       $(".rm-filter").addClass("hidden")
       $("tr.hidden").removeClass("hidden")
       $(".selected").removeClass("selected")
       if(newfilterset.length==0)
       {
         console.log("No filters enabled")
       } else {
         newfilterclass = newfilterset.map(function(f){return "filter-"+f}).join(".")
         newfilterset.forEach(function(f){
            $("tr.filter-"+f+" td a.add-filter.filter-"+f).addClass("selected")
            $("tr.filter-"+f+" td a.rm-filter.filter-"+f).removeClass("hidden")
         })
         $("tr."+newfilterclass).addClass("selected")
         $("tr").not(".selected").addClass("hidden")
       }
    }
    function get_filter_name(target)
    {
       var filtername;
       for (var i = 0; i < target.classList.length; i++) {
           if((target.classList.item(i).lastIndexOf("filter-"),0) === 0)
           {
              filtername = target.classList.item(i)
           }
       }
       return filtername;
    }
    function add_filter(event)
    {
       var filtername = get_filter_name(event.target)
       var hash = window.location.hash.split(" ")
       console.log("adding filter",filtername,"to",hash)
       hash.push(filtername);
       window.location.hash = hash.join(" ")
    }
    function remove_filter(event)
    {
       var filtername = get_filter_name(event.target)
       console.log("removing filter",filtername)
       window.location.hash=window.location.hash.replace(filtername,"")
    }
    function hash(url){
      return (((new URL(url)).hash)+"").replace("#","")
    }
    function types(url){
      return hash(url).split(" ").reduce(
        function(o,n){
          key = n.split("-")[0]
          if (o[key] === undefined)
             { o[key]=[]; }
          o[key].push(n.replace(/^\w+-/,""));
          return o;
        }, new Object()
      );
    }
    $(function() {
       if (document.location.protocol === 'https:') {
         var host = 'wss://'+document.location.host+'/ws.json'
       } else
       {
         var host = 'ws://'+document.location.host+'/ws.json'
       }
       console.log("Sparkline attempting to connect to",host)
       var ws = new ReconnectingWebSocket(host);
       window.onhashchange = function(evt){
         changeloc(evt.oldURL,evt.newURL)
       }
       ws.onmessage = function(evt) {
         data = JSON.parse(evt.data);
         if(document.getElementById("set").childNodes.length>0)
         { $('#waiting').remove() }
         console.log(data);
         $.extend(data["Dists"],data["Counters"])
         $.each(data["Dists"],function(k,v){
             if(!stored_data.hasOwnProperty(k))
             {
               stored_data[k]=[];
             }
             if((typeof v)==="number"){
               stored_data[k].push(v)
             } else {
               stored_data[k].push(v.Sum_x/v.N)
             }
             if(stored_data[k].length > 60)
             { stored_data[k].shift();}
             var name = k.replace(/\./g, "_");
             if(document.getElementById("spark-"+name) && stored_data[k].length > 1){
                $('#spark-'+name).sparkline(stored_data[k], {type: 'line'})
                $('#data-overlay-'+name).text(stored_data[k].slice(-1)[0].toFixed(3))
             }else{
                var click_filters = k.split(/\./)
                var classes = click_filters.map(function(f){return "filter-"+f;}).join(" ")
                var parts = click_filters.map(function(f){ return"<a onclick='add_filter(event)' class='add-filter filter-"+f+"'>"+f+"</a><a onclick='remove_filter(event)' class='rm-filter filter-"+f+"'>&#9003;</a>"}).join(".")
                $('#set').append($("<tr id='tr-"+name+"' class='"+classes+"'><td>"+parts+"</td><td><span class='data-overlay'><span class='data-overlay-inner' id='data-overlay-"+name+"'>"+stored_data[k].slice(-1)[0].toFixed(3)+"</span></span><a href='#graph-"+k+"'><span class='canvas' id='spark-"+name+"'></span></a></td></tr>"));
                console.log("updating locs")
                console.log(changeloc(new URL(""),document.location));
             }});
         };
    });
    </script>
</head>
<body>
  <h4 id="waiting">Waiting for data</h4>
  <span class="tools">
    <a href="#" title="Clear filters">&#9003;</a>
    <a href="#" title="Individual">&#10070;</a>
    <a href="#" title="Collapse">&#9670;</a>
  </span>
  <table>
    <tbody id="set">
    </tbody>
  </table>
</body>
</html>
