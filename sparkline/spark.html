<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
   <style>
      p {font-size:200%;}
      .canvas { z-order: 1; opacity: 0.8; }
      .data-overlay { position: relative; width:0; height: 0;}
      .data-overlay-inner { position: absolute; left: 10px; z-order: -1;}
    </style>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jquery.sparkline.js"></script>
    <script type="text/javascript" src="jquery.appear.js"></script>
    <script type="text/javascript" src="reconnecting-websocket.js"></script>
    <script type="text/javascript">
    var stored_data = {};
    $(function() {
       if (document.location.protocol === 'https:') {
         var host = 'wss://'+document.location.host+'/ws.json'
       } else
       {
         var host = 'ws://'+document.location.host+'/ws.json'
       }
       console.log("Sparkline attempting to connect to",host)
       var ws = new ReconnectingWebSocket(host);
       ws.onmessage = function(evt) {
         data = JSON.parse(evt.data);
         if(document.getElementById("set").childNodes.length>0)
         { $('#waiting').remove() }
         //console.log(data)
         $.each(data["Dists"],function(k,v){
             if(!stored_data.hasOwnProperty(k))
             {
               stored_data[k]=[];
             }
             stored_data[k].push(v.Sum_x/v.N)
             if(stored_data[k].length > 60)
             { stored_data[k].shift();}
             name = k.replace(".", "_");
             if(document.getElementById(name) && stored_data[k].length > 1){
                $('#'+name).sparkline(stored_data[k], {type: 'line'})
                $('#data-overlay-'+name).text(stored_data[k].slice(-1)[0].toFixed(3))
             }else{
                $('#set').append($("<div>"+k+":<span class='data-overlay'><span class='data-overlay-inner' id='data-overlay-"+name+"'>"+stored_data[k].slice(-1)[0].toFixed(3)+"</span></span><span class='canvas' id='"+name+"'></span></div>"));
             }});
         };
    });
    </script>
</head>
<body>
<p id="set">
<h4 id="waiting">Waiting for data</h4>
</p>
</body>
</html>
